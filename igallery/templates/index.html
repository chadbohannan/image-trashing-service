{% extends "base.html" %}

{% block title %}iGallery - Browse{% endblock %}

{% block extra_css %}
<style>
    .folders {
        margin-bottom: 30px;
    }

    .folder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .folder-item {
        display: flex;
        align-items: center;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: 8px;
        text-decoration: none;
        color: #e0e0e0;
        transition: background-color 0.2s;
    }

    .folder-item:hover {
        background-color: #3a3a3a;
    }

    .folder-icon {
        font-size: 1.5rem;
        margin-right: 10px;
    }

    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(125px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .thumbnail-item {
        position: relative;
        background-color: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s;
    }

    .thumbnail-item:hover {
        transform: scale(1.03);
    }

    .thumbnail-wrapper {
        position: relative;
        width: 100%;
        padding-top: 100%; /* 1:1 aspect ratio (square) */
        background-color: #1a1a1a;
    }

    .thumbnail-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        cursor: pointer;
    }

    .thumbnail-actions {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        display: flex;
        justify-content: space-between;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .thumbnail-item:hover .thumbnail-actions {
        opacity: 1;
    }

    .thumbnail-name {
        font-size: 0.85rem;
        color: white;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }

    .trash-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color 0.2s;
    }

    .trash-btn:hover {
        background-color: #c82333;
    }

    .empty-message {
        text-align: center;
        padding: 60px 20px;
        color: #888;
        font-size: 1.2rem;
    }

    .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .lightbox.active {
        display: flex;
    }

    .lightbox img {
        max-width: 85%;
        max-height: 85%;
        object-fit: contain;
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 40px;
        cursor: pointer;
        z-index: 1001;
    }

    .lightbox-close:hover {
        color: #4a9eff;
    }

    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-size: 48px;
        cursor: pointer;
        padding: 20px;
        user-select: none;
        z-index: 1001;
        transition: color 0.2s, opacity 0.2s;
    }

    .lightbox-nav:hover {
        color: #4a9eff;
    }

    .lightbox-nav.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .lightbox-nav.disabled:hover {
        color: white;
    }

    .lightbox-prev {
        left: 30px;
    }

    .lightbox-next {
        right: 30px;
    }

    .lightbox-counter {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 16px;
        background-color: rgba(0, 0, 0, 0.6);
        padding: 8px 16px;
        border-radius: 20px;
        z-index: 1001;
    }

    .lightbox-filename {
        position: absolute;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 18px;
        background-color: rgba(0, 0, 0, 0.6);
        padding: 8px 16px;
        border-radius: 8px;
        z-index: 1001;
        max-width: 80%;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 2000;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast-error {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block nav_left %}
<div class="breadcrumb" style="margin: 0;">
    <a href="/">Home</a>
    {% for crumb in breadcrumbs %}
        <span>/</span>
        <a href="/?path={{ crumb.path }}">{{ crumb.name }}</a>
    {% endfor %}
</div>
{% endblock %}

{% block content %}
{% if subdirectories %}
<div class="folders">
    <div class="folder-grid">
        {% for subdir in subdirectories %}
        <a href="/?path={{ (current_path + '/' + subdir) if current_path else subdir }}" class="folder-item">
            <span class="folder-icon">üìÅ</span>
            <span>{{ subdir }}</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if images %}
<div class="images">
    <div class="thumbnail-grid" id="thumbnail-grid">
        {% for image in images %}
        <div class="thumbnail-item" data-image="{{ image }}">
            <div class="thumbnail-wrapper">
                <img
                    src="/thumbnail/{{ image }}?path={{ current_path }}"
                    alt="{{ image }}"
                    class="thumbnail-img"
                >
            </div>
            <div class="thumbnail-actions">
                <span class="thumbnail-name">{{ image }}</span>
                <button class="trash-btn" onclick="trashImage('{{ image }}', event)">üóëÔ∏è</button>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="/?path={{ current_path }}&page={{ page - 1 }}&per_page={{ per_page }}">‚Üê Previous</a>
        {% endif %}

        <span class="current">{{ page }}</span>
        <span>of {{ total_pages }}</span>

        {% if page < total_pages %}
        <a href="/?path={{ current_path }}&page={{ page + 1 }}&per_page={{ per_page }}">Next ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% elif not subdirectories %}
<div class="empty-message">
    <p>No images found in this directory.</p>
</div>
{% endif %}

<div id="lightbox" class="lightbox">
    <span class="lightbox-close" onclick="closeLightbox()">√ó</span>
    <span class="lightbox-nav lightbox-prev" id="lightbox-prev" onclick="prevImage(event)">‚Äπ</span>
    <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()">
    <span class="lightbox-nav lightbox-next" id="lightbox-next" onclick="nextImage(event)">‚Ä∫</span>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Calculate optimal per_page based on viewport and thumbnail size
function calculatePerPage() {
    const thumbnailMinSize = 125; // minmax(125px, 1fr) from CSS
    const gap = 20; // gap from CSS
    const viewportWidth = window.innerWidth;

    // Calculate how many thumbnails fit per row
    const thumbnailsPerRow = Math.floor((viewportWidth + gap) / (thumbnailMinSize + gap));

    // Calculate for 4 rows minimum
    const calculatedPerPage = thumbnailsPerRow * 4;

    // Return at least 20
    return Math.max(calculatedPerPage, 20);
}

// Check if we need to reload with calculated per_page
const urlParams = new URLSearchParams(window.location.search);
const currentPerPage = parseInt(urlParams.get('per_page')) || 20;
const optimalPerPage = calculatePerPage();

if (currentPerPage !== optimalPerPage && !urlParams.has('per_page')) {
    // Reload with optimal per_page if not explicitly set
    urlParams.set('per_page', optimalPerPage);
    window.location.search = urlParams.toString();
}

// Initialize variables for gallery and lightbox
let currentPage = {{ page }};
let totalPages = {{ total_pages }};
const currentPath = "{{ current_path }}";

// Build array of images for lightbox navigation
let galleryImages = [];

function updateGalleryImages(images) {
    galleryImages.length = 0;
    images.forEach(img => {
        galleryImages.push({
            name: img,
            url: `/image/${img}?path=${currentPath}`
        });
    });
    initLightboxThumbnails();
}

// Initial population
updateGalleryImages([
    {% for image in images %}
        "{{ image }}"{{ "," if not loop.last else "" }}
    {% endfor %}
]);

let currentImageIndex = 0;

function initLightboxThumbnails() {
    const thumbnails = document.querySelectorAll('.thumbnail-img');
    thumbnails.forEach((thumbnail, index) => {
        thumbnail.onclick = (event) => openLightbox(index, event);
    });
}

function openLightbox(index, event) {
    if (event) event.stopPropagation();
    if (galleryImages.length === 0) return;

    currentImageIndex = index;
    updateLightboxImage();

    const lightbox = document.getElementById('lightbox');
    lightbox.classList.add('active');

    // Record view
    recordImageView(galleryImages[currentImageIndex].name);
}

function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.remove('active');
}

function updateLightboxImage() {
    const img = document.getElementById('lightbox-img');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    const currentImage = galleryImages[currentImageIndex];
    img.src = currentImage.url;

    // Update button states
    if (currentImageIndex === 0 && currentPage === 1) {
        prevBtn.classList.add('disabled');
    } else {
        prevBtn.classList.remove('disabled');
    }

    if (currentImageIndex === galleryImages.length - 1 && currentPage === totalPages) {
        nextBtn.classList.add('disabled');
    } else {
        nextBtn.classList.remove('disabled');
    }
}

async function loadImagesForPage(pageNumber, initialImageIndex) {
    const perPage = optimalPerPage || 20;
    const response = await fetch(`/?path=${currentPath}&page=${pageNumber}&per_page=${perPage}&fetch_images_only=true`);
    const data = await response.json();

    if (data.success) {
        // Update the main thumbnail grid in the DOM
        const thumbnailGrid = document.getElementById('thumbnail-grid');
        thumbnailGrid.innerHTML = ''; // Clear existing thumbnails
        data.images.forEach(imgName => {
            const div = document.createElement('div');
            div.className = 'thumbnail-item';
            div.setAttribute('data-image', imgName);
            div.innerHTML = `
                <div class="thumbnail-wrapper">
                    <img
                        src="/thumbnail/${imgName}?path=${currentPath}"
                        alt="${imgName}"
                        class="thumbnail-img"
                    >
                </div>
                <div class="thumbnail-actions">
                    <span class="thumbnail-name">${imgName}</span>
                    <button class="trash-btn" onclick="trashImage('${imgName}', event)">üóëÔ∏è</button>
                </div>
            `;
            thumbnailGrid.appendChild(div);
        });

        updateGalleryImages(data.images); // Update the galleryImages array and re-init event listeners
        currentPage = data.page;
        totalPages = data.total_pages;
        currentImageIndex = (initialImageIndex === -1) ? galleryImages.length - 1 : initialImageIndex;
        updateLightboxImage();

        // Update the pagination links at the bottom of the page
        const paginationDiv = document.querySelector('.pagination');
        if (paginationDiv) {
            const perPage = optimalPerPage || 20;
            let newPaginationHtml = '';
            if (currentPage > 1) {
                newPaginationHtml += `<a href="/?path=${currentPath}&page=${currentPage - 1}&per_page=${perPage}">‚Üê Previous</a>`;
            }
            newPaginationHtml += `<span class="current">${currentPage}</span>`;
            newPaginationHtml += `<span>of ${totalPages}</span>`;
            if (currentPage < totalPages) {
                newPaginationHtml += `<a href="/?path=${currentPath}&page=${currentPage + 1}&per_page=${perPage}">Next ‚Üí</a>`;
            }
            paginationDiv.innerHTML = newPaginationHtml;
        }

    } else {
        showToast(`Error loading images: ${data.error}`, 'error');
    }
}

function prevImage(event) {
    if (event) event.stopPropagation();
    if (currentImageIndex > 0) {
        currentImageIndex--;
        updateLightboxImage();
        recordImageView(galleryImages[currentImageIndex].name);
    } else if (currentPage > 1) {
        // Load previous page, and set index to last image of that page
        loadImagesForPage(currentPage - 1, -1); // -1 will be handled in loadImagesForPage to point to the last image
    }
}

function nextImage(event) {
    if (event) event.stopPropagation();
    if (currentImageIndex < galleryImages.length - 1) {
        currentImageIndex++;
        updateLightboxImage();
        recordImageView(galleryImages[currentImageIndex].name);
    } else if (currentPage < totalPages) {
        // Load next page, and set index to first image of that page
        loadImagesForPage(currentPage + 1, 0);
    }
}

function recordImageView(imageName) {
    const currentPath = "{{ current_path }}";
    // Silent request to record view
    fetch(`/image/${imageName}?path=${currentPath}`, {
        method: 'HEAD'
    }).catch(() => {
        // Ignore errors in view tracking
    });
}

function trashImage(imageName, event, fromLightbox = false) {
    if (event) event.stopPropagation();

    const currentPath = "{{ current_path }}";

    fetch(`/trash?path=${currentPath}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image_name: imageName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove thumbnail from page
            const item = document.querySelector(`[data-image="${imageName}"]`);
            if (item) {
                item.remove();
            }

            // Rebuild galleryImages array and handle lightbox
            const index = galleryImages.findIndex(img => img.name === imageName);
            if (index !== -1) {
                galleryImages.splice(index, 1);
            }

            // Re-initialize lightbox click handlers with updated indices
            initLightboxThumbnails();

            // Handle lightbox behavior when deleting from lightbox
            if (fromLightbox) {
                if (galleryImages.length === 0) {
                    // No more images, close lightbox
                    closeLightbox();
                } else {
                    // Stay at same index (shows next image), or go back one if we deleted the last image
                    if (currentImageIndex >= galleryImages.length) {
                        currentImageIndex = galleryImages.length - 1;
                    }
                    updateLightboxImage();
                    recordImageView(galleryImages[currentImageIndex].name);
                }
            }

            // Check if page is now empty
            const remainingItems = document.querySelectorAll('.thumbnail-item');
            if (remainingItems.length === 0) {
                location.reload();
            }
        } else {
            showToast('Error moving image to trash', 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
    });
}

function showToast(message, type = 'success') {
    // Remove existing toast if any
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}


// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox.classList.contains('active')) return;

    switch(e.key) {
        case 'Escape':
            closeLightbox();
            break;
        case 'ArrowLeft':
            prevImage();
            break;
        case 'ArrowRight':
        case ' ':
            e.preventDefault(); // Prevent space from scrolling
            nextImage();
            break;
        case 'Backspace':
        case 'Delete':
            e.preventDefault(); // Prevent browser back navigation
            if (galleryImages.length > 0) {
                const currentImage = galleryImages[currentImageIndex];
                trashImage(currentImage.name, null, true);
            }
            break;
    }
});
</script>
{% endblock %}
