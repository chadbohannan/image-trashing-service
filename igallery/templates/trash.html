{% extends "base.html" %}

{% block title %}Trash - Image Trashing Service{% endblock %}

{% block nav_left %}
<div class="breadcrumb" style="margin: 0;">
    <a href="/">Home</a>
    <span>/</span>
    <span style="color: #e0e0e0;">Trash</span>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .trash-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 30px;
    }

    .delete-all-btn {
        background-color: #dc3545;
        padding: 12px 24px;
        font-size: 1rem;
    }

    .delete-all-btn:hover {
        background-color: #c82333;
    }

    .delete-all-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .delete-metadata-btn {
        background-color: #6c757d;
        padding: 12px 24px;
        font-size: 1rem;
    }

    .delete-metadata-btn:hover {
        background-color: #5a6268;
    }

    .delete-metadata-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(125px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .thumbnail-item {
        position: relative;
        background-color: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s;
        border: 2px solid #dc3545;
    }

    .thumbnail-item:hover {
        transform: scale(1.03);
    }

    .thumbnail-wrapper {
        position: relative;
        width: 100%;
        padding-top: 100%; /* 1:1 aspect ratio (square) */
        background-color: #1a1a1a;
    }

    .thumbnail-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .thumbnail-info {
        padding: 10px;
        background-color: #2a2a2a;
    }

    .thumbnail-name {
        font-size: 0.85rem;
        color: #e0e0e0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-bottom: 8px;
    }

    .thumbnail-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .restore-btn {
        flex: 1;
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color 0.2s;
    }

    .restore-btn:hover {
        background-color: #218838;
    }

    .restore-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 2000;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast-error {
        background-color: #dc3545;
    }

    .empty-message {
        text-align: center;
        padding: 60px 20px;
        color: #888;
        font-size: 1.2rem;
    }

    .warning-badge {
        display: inline-block;
        background-color: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
{% if image_count > 0 %}
<div class="trash-header">
    <button
        id="delete-all-btn"
        class="btn delete-all-btn"
        onclick="deleteAllTrash()"
    >
        Delete {{ image_count }} Image{{ 's' if image_count != 1 else '' }}
    </button>
</div>
{% else %}
<div class="trash-header">
    <button
        id="delete-metadata-btn"
        class="btn delete-metadata-btn"
        onclick="deleteMetadata()"
        title="Delete all cached thumbnails and image view timestamps. This will reset the sequence of images presented in the Carousel to file modification time order. This action cannot be undone."
    >
        Delete All Metadata
    </button>
</div>
{% endif %}

{% if images %}
<div class="thumbnail-grid">
    {% for image in images %}
    <div class="thumbnail-item" data-trash-path="{{ image.path }}">
        <div class="thumbnail-wrapper">
            <img
                src="/trash/thumbnail/{{ image.path }}"
                alt="{{ image.path }}"
                class="thumbnail-img"
            >
        </div>
        <div class="thumbnail-info">
            <div class="thumbnail-name" title="Original: {{ image.original }}">{{ image.path }}</div>
            <div class="thumbnail-actions">
                <button class="restore-btn" onclick="restoreImage('{{ image.path }}', event)">↶ Restore</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-message">
    <p>✨ Trash is empty</p>
    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
        Images you move to trash will appear here
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
let currentImageCount = {{ image_count }};

function updateDeleteButton() {
    const btn = document.getElementById('delete-all-btn');
    if (btn) {
        if (currentImageCount === 0) {
            btn.style.display = 'none';
        } else {
            btn.textContent = `Delete ${currentImageCount} Image${currentImageCount !== 1 ? 's' : ''}`;
        }
    }
}

function restoreImage(trashPath, event) {
    event.stopPropagation();

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Restoring...';

    fetch('/trash/restore', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ trash_path: trashPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove thumbnail from page
            const item = document.querySelector(`[data-trash-path="${trashPath}"]`);
            if (item) {
                item.remove();
            }

            // Decrement count and update button
            currentImageCount--;
            updateDeleteButton();

            // Check if page is now empty
            const remainingItems = document.querySelectorAll('.thumbnail-item');
            if (remainingItems.length === 0) {
                location.reload();
            }
        } else {
            showToast('Error restoring image: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = '↶ Restore';
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = '↶ Restore';
    });
}

function deleteAllTrash() {
    const btn = document.getElementById('delete-all-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    fetch('/trash/delete-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Successfully deleted ${data.deleted} images`);
            location.reload();
        } else {
            showToast('Error deleting trash: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = `Delete ${currentImageCount} image${currentImageCount !== 1 ? 's' : ''}`;
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = `Delete ${currentImageCount} image${currentImageCount !== 1 ? 's' : ''}`;
    });
}

function deleteMetadata() {
    if (!confirm('Are you sure you want to delete all metadata? This will:\n\n• Delete all cached thumbnails\n• Delete all image view timestamps\n• Reset carousel ordering to file modification time\n\nThis action cannot be undone.')) {
        return;
    }

    const btn = document.getElementById('delete-metadata-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    fetch('/metadata/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Metadata deleted successfully. Thumbnails will regenerate as needed.');
            setTimeout(() => {
                location.href = '/';
            }, 2000);
        } else {
            showToast('Error deleting metadata: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = 'Delete All Metadata';
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = 'Delete All Metadata';
    });
}

function showToast(message, type = 'success') {
    // Remove existing toast if any
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // ESC navigates back to gallery root
    if (e.key === 'Escape') {
        e.preventDefault();
        window.location.href = '/';
        return;
    }

    // Delete/Backspace triggers delete all
    if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault(); // Prevent browser back navigation

        const deleteAllBtn = document.getElementById('delete-all-btn');
        if (deleteAllBtn && !deleteAllBtn.disabled) {
            deleteAllTrash();
        }
    }
});
</script>
{% endblock %}
