{% extends "base.html" %}

{% block title %}Trash - Image Trashing Service{% endblock %}

{% block nav_left %}
<div class="breadcrumb" style="margin: 0;">
    <a href="/">Home</a>
    <span>/</span>
    <span style="color: #e0e0e0;">Trash</span>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .trash-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 30px;
    }

    .delete-all-btn {
        background-color: #dc3545;
        padding: 12px 24px;
        font-size: 1rem;
    }

    .delete-all-btn:hover {
        background-color: #c82333;
    }

    .delete-all-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .delete-metadata-btn {
        background-color: #6c757d;
        padding: 12px 24px;
        font-size: 1rem;
    }

    .delete-metadata-btn:hover {
        background-color: #5a6268;
    }

    .delete-metadata-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(125px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .thumbnail-item {
        position: relative;
        background-color: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s;
        border: 2px solid #dc3545;
        cursor: pointer;
    }

    .thumbnail-item:hover {
        transform: scale(1.03);
    }

    .thumbnail-wrapper {
        position: relative;
        width: 100%;
        padding-top: 100%; /* 1:1 aspect ratio (square) */
        background-color: #1a1a1a;
    }

    .thumbnail-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 2000;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast-error {
        background-color: #dc3545;
    }

    .empty-message {
        text-align: center;
        padding: 60px 20px;
        color: #888;
        font-size: 1.2rem;
    }

    .warning-badge {
        display: inline-block;
        background-color: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-left: 10px;
    }

    .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .lightbox.active {
        display: flex;
    }

    .lightbox img {
        max-width: 85%;
        max-height: 85%;
        object-fit: contain;
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 40px;
        cursor: pointer;
        z-index: 1001;
    }

    .lightbox-close:hover {
        color: #4a9eff;
    }

    .lightbox-restore {
        position: absolute;
        bottom: 20px;
        right: 15px;
        color: white;
        font-size: 32px;
        cursor: pointer;
        z-index: 1001;
        background-color: transparent;
        padding: 8px 16px;
        border-radius: 8px;
        transition: opacity 0.2s;
    }

    .lightbox-restore:hover {
        opacity: 0.7;
    }

    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-size: 48px;
        cursor: pointer;
        padding: 20px;
        user-select: none;
        z-index: 1001;
        transition: color 0.2s, opacity 0.2s;
    }

    .lightbox-nav:hover {
        color: #4a9eff;
    }

    .lightbox-nav.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .lightbox-nav.disabled:hover {
        color: white;
    }

    .lightbox-prev {
        left: 30px;
    }

    .lightbox-next {
        right: 30px;
    }

    .lightbox-filename {
        position: absolute;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 18px;
        background-color: rgba(0, 0, 0, 0.6);
        padding: 8px 16px;
        border-radius: 8px;
        z-index: 1001;
        max-width: 80%;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
{% if image_count > 0 %}
<div class="trash-header">
    <button
        id="delete-all-btn"
        class="btn delete-all-btn"
        onclick="deleteAllTrash()"
    >
        Delete {{ image_count }} Image{{ 's' if image_count != 1 else '' }}
    </button>
</div>
{% else %}
<div class="trash-header">
    <button
        id="delete-metadata-btn"
        class="btn delete-metadata-btn"
        onclick="deleteMetadata()"
        title="Delete all cached thumbnails and image view timestamps. This will reset the sequence of images presented in the Carousel to file modification time order. This action cannot be undone."
    >
        Delete All Metadata
    </button>
</div>
{% endif %}

{% if images %}
<div class="thumbnail-grid">
    {% for image in images %}
    <div class="thumbnail-item" data-trash-path="{{ image.path }}" data-original-path="{{ image.original }}">
        <div class="thumbnail-wrapper">
            <img
                src="/trash/thumbnail/{{ image.path }}"
                alt="{{ image.path }}"
                class="thumbnail-img"
            >
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-message">
    <p>✨ Trash is empty</p>
    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
        Images you move to trash will appear here
    </p>
</div>
{% endif %}

<div id="lightbox" class="lightbox">
    <span class="lightbox-close" onclick="closeLightbox()">×</span>
    <span class="lightbox-restore" onclick="restoreCurrentLightboxImage()" title="Restore image">↶</span>
    <span class="lightbox-nav lightbox-prev" id="lightbox-prev" onclick="prevImage()">‹</span>
    <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()">
    <span class="lightbox-nav lightbox-next" id="lightbox-next" onclick="nextImage()">›</span>
    <div class="lightbox-filename" id="lightbox-filename"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentImageCount = {{ image_count }};

// Build array of trash images for lightbox navigation
let trashImages = [];
let currentImageIndex = 0;

function updateTrashImages() {
    trashImages = [];
    const thumbnails = document.querySelectorAll('.thumbnail-item');
    thumbnails.forEach((item, index) => {
        trashImages.push({
            trashPath: item.dataset.trashPath,
            originalPath: item.dataset.originalPath,
            thumbnailUrl: `/trash/thumbnail/${item.dataset.trashPath}`,
            imageUrl: `/trash/image/${item.dataset.trashPath}`
        });
    });
    initLightboxThumbnails();
}

function initLightboxThumbnails() {
    const thumbnails = document.querySelectorAll('.thumbnail-item');
    thumbnails.forEach((thumbnail, index) => {
        thumbnail.onclick = () => openLightbox(index);
    });
}

function openLightbox(index) {
    if (trashImages.length === 0) return;

    currentImageIndex = index;
    updateLightboxImage();

    const lightbox = document.getElementById('lightbox');
    lightbox.classList.add('active');
}

function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.remove('active');
}

function updateLightboxImage() {
    const img = document.getElementById('lightbox-img');
    const filename = document.getElementById('lightbox-filename');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    const currentImage = trashImages[currentImageIndex];

    img.src = currentImage.imageUrl;
    filename.textContent = currentImage.trashPath;

    // Update button states
    if (currentImageIndex === 0) {
        prevBtn.classList.add('disabled');
    } else {
        prevBtn.classList.remove('disabled');
    }

    if (currentImageIndex === trashImages.length - 1) {
        nextBtn.classList.add('disabled');
    } else {
        nextBtn.classList.remove('disabled');
    }
}

function prevImage() {
    if (currentImageIndex > 0) {
        currentImageIndex--;
        updateLightboxImage();
    }
}

function nextImage() {
    if (currentImageIndex < trashImages.length - 1) {
        currentImageIndex++;
        updateLightboxImage();
    }
}

function restoreCurrentLightboxImage() {
    if (trashImages.length === 0) return;

    const currentImage = trashImages[currentImageIndex];
    restoreImage(currentImage.trashPath, true);
}

function restoreImage(trashPath, fromLightbox = false) {
    fetch('/trash/restore', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ trash_path: trashPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove thumbnail from page
            const item = document.querySelector(`[data-trash-path="${trashPath}"]`);
            if (item) {
                item.remove();
            }

            // Find index and remove from array
            const index = trashImages.findIndex(img => img.trashPath === trashPath);
            if (index !== -1) {
                trashImages.splice(index, 1);
            }

            // Re-initialize click handlers
            initLightboxThumbnails();

            // Decrement count and update button
            currentImageCount--;
            updateDeleteButton();

            // Handle lightbox navigation after restore
            if (fromLightbox) {
                if (trashImages.length === 0) {
                    // No more images, close lightbox and reload
                    closeLightbox();
                    location.reload();
                    return;
                }

                // Adjust index if needed
                if (currentImageIndex >= trashImages.length) {
                    currentImageIndex = trashImages.length - 1;
                }

                updateLightboxImage();
            } else {
                // Check if page is now empty
                const remainingItems = document.querySelectorAll('.thumbnail-item');
                if (remainingItems.length === 0) {
                    location.reload();
                }
            }
        } else {
            showToast('Error restoring image: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
    });
}

function updateDeleteButton() {
    const btn = document.getElementById('delete-all-btn');
    if (btn) {
        if (currentImageCount === 0) {
            btn.style.display = 'none';
        } else {
            btn.textContent = `Delete ${currentImageCount} Image${currentImageCount !== 1 ? 's' : ''}`;
        }
    }
}

function deleteAllTrash() {
    const btn = document.getElementById('delete-all-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    fetch('/trash/delete-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Successfully deleted ${data.deleted} images`);
            location.reload();
        } else {
            showToast('Error deleting trash: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = `Delete ${currentImageCount} image${currentImageCount !== 1 ? 's' : ''}`;
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = `Delete ${currentImageCount} image${currentImageCount !== 1 ? 's' : ''}`;
    });
}

function deleteMetadata() {
    if (!confirm('Are you sure you want to delete all metadata? This will:\n\n• Delete all cached thumbnails\n• Delete all image view timestamps\n• Reset carousel ordering to file modification time\n\nThis action cannot be undone.')) {
        return;
    }

    const btn = document.getElementById('delete-metadata-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    fetch('/metadata/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Metadata deleted successfully. Thumbnails will regenerate as needed.');
            setTimeout(() => {
                location.href = '/';
            }, 2000);
        } else {
            showToast('Error deleting metadata: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = 'Delete All Metadata';
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = 'Delete All Metadata';
    });
}

function showToast(message, type = 'success') {
    // Remove existing toast if any
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('lightbox');
    const lightboxActive = lightbox.classList.contains('active');

    // Handle ESC key
    if (e.key === 'Escape') {
        e.preventDefault();
        if (lightboxActive) {
            // Close lightbox
            closeLightbox();
        } else {
            // Navigate back to gallery root
            window.location.href = '/';
        }
        return;
    }

    // Other keys only work when lightbox is active
    if (!lightboxActive) {
        // Delete/Backspace triggers delete all when not in lightbox
        if (e.key === 'Delete' || e.key === 'Backspace') {
            e.preventDefault(); // Prevent browser back navigation

            const deleteAllBtn = document.getElementById('delete-all-btn');
            if (deleteAllBtn && !deleteAllBtn.disabled) {
                deleteAllTrash();
            }
        }
        return;
    }

    // Lightbox-specific keyboard shortcuts
    switch(e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            prevImage();
            break;
        case 'ArrowRight':
        case ' ':
            e.preventDefault(); // Prevent space from scrolling
            nextImage();
            break;
    }
});

// Initialize trash images array on page load
updateTrashImages();
</script>
{% endblock %}
