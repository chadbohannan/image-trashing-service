{% extends "base.html" %}

{% block title %}iGallery - Trash{% endblock %}

{% block nav_left %}
<div class="breadcrumb" style="margin: 0;">
    <a href="/">Home</a>
    <span>/</span>
    <span style="color: #e0e0e0;">Trash</span>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .trash-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 30px;
    }

    .delete-all-btn {
        background-color: #dc3545;
        padding: 12px 24px;
        font-size: 1rem;
    }

    .delete-all-btn:hover {
        background-color: #c82333;
    }

    .delete-all-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .thumbnail-item {
        position: relative;
        background-color: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s;
        border: 2px solid #dc3545;
    }

    .thumbnail-item:hover {
        transform: scale(1.03);
    }

    .thumbnail-wrapper {
        position: relative;
        width: 100%;
        padding-top: 75%; /* 4:3 aspect ratio */
        background-color: #1a1a1a;
    }

    .thumbnail-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .thumbnail-info {
        padding: 10px;
        background-color: #2a2a2a;
    }

    .thumbnail-name {
        font-size: 0.85rem;
        color: #e0e0e0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-bottom: 8px;
    }

    .thumbnail-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .restore-btn {
        flex: 1;
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color 0.2s;
    }

    .restore-btn:hover {
        background-color: #218838;
    }

    .restore-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 2000;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast-error {
        background-color: #dc3545;
    }

    .empty-message {
        text-align: center;
        padding: 60px 20px;
        color: #888;
        font-size: 1.2rem;
    }

    .warning-badge {
        display: inline-block;
        background-color: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
{% if image_count > 0 %}
<div class="trash-header">
    <button
        id="delete-all-btn"
        class="btn delete-all-btn"
        onclick="deleteAllTrash()"
    >
        Delete {{ image_count }} Image{{ 's' if image_count != 1 else '' }}
    </button>
</div>
{% endif %}

{% if images %}
<div class="thumbnail-grid">
    {% for image in images %}
    <div class="thumbnail-item" data-trash-path="{{ image.path }}">
        <div class="thumbnail-wrapper">
            <img
                src="/trash/thumbnail/{{ image.path }}"
                alt="{{ image.path }}"
                class="thumbnail-img"
            >
        </div>
        <div class="thumbnail-info">
            <div class="thumbnail-name" title="Original: {{ image.original }}">{{ image.path }}</div>
            <div class="thumbnail-actions">
                <button class="restore-btn" onclick="restoreImage('{{ image.path }}', event)">↶ Restore</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-message">
    <p>✨ Trash is empty</p>
    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
        Images you move to trash will appear here
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function restoreImage(trashPath, event) {
    event.stopPropagation();

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Restoring...';

    fetch('/trash/restore', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ trash_path: trashPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove thumbnail from page
            const item = document.querySelector(`[data-trash-path="${trashPath}"]`);
            if (item) {
                item.remove();
            }

            // Update count and check if page is now empty
            const remainingItems = document.querySelectorAll('.thumbnail-item');
            if (remainingItems.length === 0) {
                location.reload();
            }
        } else {
            showToast('Error restoring image: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = '↶ Restore';
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = '↶ Restore';
    });
}

function deleteAllTrash() {
    const imageCount = {{ image_count }};
    if (!confirm(`⚠️ Permanently delete ${imageCount} image${imageCount !== 1 ? 's' : ''} from trash?\n\nThis action cannot be undone!`)) {
        return;
    }

    const btn = document.getElementById('delete-all-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    fetch('/trash/delete-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Successfully deleted ${data.deleted} images`);
            location.reload();
        } else {
            showToast('Error deleting trash: ' + (data.error || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.textContent = `Delete ${imageCount} image${imageCount !== 1 ? 's' : ''}`;
        }
    })
    .catch(error => {
        showToast('Error: ' + error, 'error');
        btn.disabled = false;
        btn.textContent = `Delete ${imageCount} image${imageCount !== 1 ? 's' : ''}`;
    });
}

function showToast(message, type = 'success') {
    // Remove existing toast if any
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
